<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ulo Building's page</title>
    <link rel="manifest" href="manifest.json" />
    <link
      rel="icon"
      type="image/png"
      href="Images4Estate/Favicon3 32x32 pngegg.png"
      sizes="32x32"
    />
    <!-- <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />  -->
    <link rel="stylesheet" href="output.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      .modal-content {
        /* max-height: 80vh; */
        overflow-y: auto;
      }
      /* .option-border {
          border-bottom: 1px solid #f80303;
        } */
    </style>
  </head>
  <body class="bg-green-600">
    <header
      class="bg-green-900 shadow -mb-4 p-2 md:p-4 flex justify-between items-center"
    >
      <div class="flex items-center">
        <!-- <button id="backButton" class="mr-4 md:mr-6"> -->
        <!-- Single line html 'a' tag code for back arrow. -->
        <!-- <a href="javascript:history.back()">
            <svg
              class="w-6 h-6 md:w-8 md:h-8 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
            <p
              class="hidden md:block mr-4 -mt-1.5 text-white text-sm flex-nowrap"
            >
              Back
            </p>
          </a> -->
        <!-- </button> -->
        <a href="estate1.html">
          <div
            class="flex flex-col justify-center mx-auto items-center md:mx-4 pl-2"
          >
            <img
              src="Images4Estate/house_5 google.svg"
              alt=""
              class="w-6 h-6 md:w-8 md:h-8 mr-4 md:mr-6"
            />
            <p class="hidden md:block mr-4 -mt-1.5 text-white text-sm">Home</p>
          </div>
        </a>
        <a href="tenantdb3.html">
          <div class="flex flex-col justify-center mx-auto items-center">
            <img
              src="Images4Estate/Persons groups.svg"
              alt=""
              class="w-6 h-6 md:w-8 md:h-8 mr-4"
            />
            <p class="hidden md:block mr-4 -mt-2 text-white text-sm">Tenants</p>
          </div>
        </a>

        <!-- <h1 class="text-white text-xl font-bold">Building</h1> -->
      </div>
      <div class="flex items-center">
        <div
          class="flex flex-col md:flex-row items-center text-sm md:text-base"
        >
          <div class="pb-2 md:pb-0">
            <select
              id="searchCriteria"
              name="searchCriteria"
              class="border pl-0 md:pl-2 py-0 rounded w-40 md:w-48 h-8 md:h-10 mr-0 md:mr-1"
            >
              <option value="allBuildings">All Buildings</option>
              <option value="BuildingSearch">Building Search</option>
              <option value="fullyRented">Fully Rented</option>
              <option value="vacantFlats">Vacant Flats</option>
              <option value="maintenance">Maintenance Required</option>
              <option value="noMaintenance">No Maintenance</option>
            </select>
          </div>
          <div class="flex items-center ml-0">
            <input
              type="text"
              id="searchBox"
              placeholder="Search..."
              class="border pl-1 md:pl-2 rounded-tl rounded-bl mr-0 w-32 md:w-40 h-8 md:h-10"
            />
            <img
              id="searchImage"
              src="Images4Estate/Search.256.png"
              alt="Search Image"
              class="h-8 w-8 md:h-10 md:w-10 rounded-tr rounded-br bg-green-400 hover:bg-blue-400 p-1 mr-0 md:mr-8 cursor-pointer"
            />
          </div>
        </div>
      </div>
      <div class="flex items-center">
        <button id="addButton" class="ml-4 text-white mr-2 md:mr-4">
          <div class="flex flex-col justify-center mx-auto items-center">
            <img
              src="Images4Estate/add_home Google.svg"
              alt=""
              class="w-6 h-6 md:w-8 md:h-8 mr-4 md:mr-6"
            />
            <p
              class="hidden md:block mr-4 -mt-1.5 text-white text-sm flex-nowrap"
            >
              Add building
            </p>
          </div>
        </button>
        <a href="index.html">
          <div class="flex flex-col justify-center mx-auto items-center">
            <img
              src="Images4Estate/logout_Google.svg"
              alt=""
              class="w-6 h-6 md:w-8 md:h-8 mr-2"
            />
            <p
              class="hidden md:block mr-4 -mt-1.5 text-white text-sm flex-nowrap"
            >
              logout
            </p>
          </div>
        </a>
      </div>
    </header>
    <div class="bg-blue-100 h-1 w-screen mt-4"></div>
    <main class="p-2 md:p-4 md:w-2/3 lg:w-3/4 md:m-auto">
      <div class="flex justify-center">
        <h1
          class="bg-blue-100 py-1 px-6 rounded-full text-green-900 text-xl font-semibold md:font-bold mt-2 -mb-0 md:mb-0"
        >
          Buildings' page
        </h1>
      </div>
      <div
        id="buildingForm"
        class="hidden mt-20 modal-content fixed inset-0 bg-green-100 p-4 rounded shadow-lg w-full max-w-lg mx-auto"
      >
        <h2 class="text-xl font-bold mb-4">Add Building</h2>
        <form id="form" autocomplete="off">
          <div class="mb-4">
            <label
              for="buildingName"
              class="block text-sm font-medium text-gray-700"
              >Name of Building</label
            >
            <input
              required
              type="text"
              id="buildingName"
              class="mt-1 block w-full border rounded p-2"
            />
          </div>
          <div class="mb-4">
            <label for="address" class="block text-sm font-medium text-gray-700"
              >Address</label
            >
            <input
              type="text"
              id="address"
              class="mt-1 block w-full border rounded p-2"
            />
          </div>
          <div class="mb-4">
            <label
              for="numFlats"
              class="block text-sm font-medium text-gray-700"
              >No. of Flats</label
            >
            <input
              type="number"
              id="numFlats"
              class="mt-1 block w-full border rounded p-2"
            />
          </div>
          <div class="mb-4">
            <label
              for="numTenants"
              class="block text-sm font-medium text-gray-700"
              >No. of Tenants</label
            >
            <input
              type="number"
              id="numTenants"
              class="mt-1 block w-full border rounded p-2"
            />
          </div>
          <div class="mb-4">
            <label
              for="numPaidTenants"
              class="block text-sm font-medium text-gray-700"
              >No. of Paid-up Tenants</label
            >
            <input
              type="number"
              id="numPaidTenants"
              class="mt-1 block w-full border rounded p-2"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700"
              >Maintenance Required?</label
            >
            <div class="mt-1">
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="maintenance"
                  value="yes"
                  class="form-radio"
                />
                <span class="ml-2">Yes</span>
              </label>
              <label class="inline-flex items-center ml-6">
                <input
                  type="radio"
                  name="maintenance"
                  value="no"
                  class="form-radio"
                />
                <span class="ml-2">No</span>
              </label>
            </div>
          </div>
          <div class="mb-4">
            <label for="notes" class="block text-sm font-medium text-gray-700"
              >Notes</label
            >
            <textarea
              id="notes"
              class="mt-1 block w-full border rounded p-2"
            ></textarea>
          </div>
          <div class="flex justify-end">
            <button
              type="submit"
              id="submitButton"
              class="bg-blue-500 text-white px-2 py-2 rounded border-2 border-white shadow-md"
            >
              Submit
            </button>
            <button
              type="button"
              id="saveButton"
              class="bg-green-500 text-white px-2 py-2 rounded hidden border-2 border-white shadow-md"
            >
              Save
            </button>
            <button
              type="button"
              id="cancelButton"
              class="bg-red-500 text-white px-2 py-2 rounded ml-2 border-2 border-white shadow-md"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
      <div id="buildingList" class="mt-4">
        <!-- Building entries will be displayed here -->
      </div>
    </main>

    <!-- <script src="app.js"></script> -->
    <script>
      // Clear IndexedDB (run this once) to help clear errors with indexedDB,
      // Comment out the code below after running it once! and save your code
      // indexedDB.deleteDatabase("BuildingsDB");

      document.addEventListener("DOMContentLoaded", () => {
        const addButton = document.getElementById("addButton");
        const buildingForm = document.getElementById("buildingForm");
        const form = document.getElementById("form");
        const cancelButton = document.getElementById("cancelButton");
        const submitButton = document.getElementById("submitButton");
        const saveButton = document.getElementById("saveButton");
        const buildingList = document.getElementById("buildingList");

        let db;
        let editMode = false;
        let editId = null;

        // Open IndexedDB
        const request = indexedDB.open("BuildingDB", 1);

        request.onupgradeneeded = (event) => {
          db = event.target.result;
          const objectStore = db.createObjectStore("buildings", {
            keyPath: "id",
            autoIncrement: true,
          });
          objectStore.createIndex("name", "name", { unique: false });
        };

        request.onsuccess = (event) => {
          db = event.target.result;
          loadBuildings();
        };

        request.onerror = (event) => {
          console.error("Database error:", event.target.errorCode);
        };

        addButton.addEventListener("click", () => {
          buildingForm.classList.remove("hidden");
          submitButton.classList.remove("hidden");
          saveButton.classList.add("hidden");
          form.reset();
          editMode = false;
        });

        cancelButton.addEventListener("click", () => {
          buildingForm.classList.add("hidden");
        });

        submitButton.addEventListener("click", (event) => {
          event.preventDefault();
          const building = {
            name: form.buildingName.value,
            address: form.address.value,
            numFlats: parseInt(form.numFlats.value),
            numTenants: parseInt(form.numTenants.value),
            numPaidTenants: parseInt(form.numPaidTenants.value),
            maintenance: form.maintenance.value,
            notes: form.notes.value,
          };
          building.numVacantFlats = building.numFlats - building.numTenants;
          building.numTenantsOwing =
            building.numTenants - building.numPaidTenants;

          addBuilding(building);
          buildingForm.classList.add("hidden");
        });

        saveButton.addEventListener("click", (event) => {
          event.preventDefault();
          const building = {
            name: form.buildingName.value,
            address: form.address.value,
            numFlats: parseInt(form.numFlats.value),
            numTenants: parseInt(form.numTenants.value),
            numPaidTenants: parseInt(form.numPaidTenants.value),
            maintenance: form.maintenance.value,
            notes: form.notes.value,
          };
          building.numVacantFlats = building.numFlats - building.numTenants;
          building.numTenantsOwing =
            building.numTenants - building.numPaidTenants;

          updateBuilding(editId, building);
          buildingForm.classList.add("hidden");
        });

        function addBuilding(building) {
          const transaction = db.transaction(["buildings"], "readwrite");
          const objectStore = transaction.objectStore("buildings");
          const request = objectStore.add(building);

          request.onsuccess = () => {
            loadBuildings();
          };

          request.onerror = (event) => {
            console.error("Add building error:", event.target.errorCode);
          };
        }

        function updateBuilding(id, building) {
          const transaction = db.transaction(["buildings"], "readwrite");
          const objectStore = transaction.objectStore("buildings");
          const request = objectStore.put({ ...building, id });

          request.onsuccess = () => {
            loadBuildings();
          };

          request.onerror = (event) => {
            console.error("Update building error:", event.target.errorCode);
          };
        }
        // My UNDO STOP POINT - Undo stop point for SEARCH
        // function loadBuildings() {
        //   buildingList.innerHTML = "";
        //   const transaction = db.transaction(["buildings"], "readonly");
        //   const objectStore = transaction.objectStore("buildings");
        //   const request = objectStore.openCursor();
        //   let index = 0;

        //   request.onsuccess = (event) => {
        //     const cursor = event.target.result;
        //     if (cursor) {
        //       const building = cursor.value;
        //       const bgColor = index % 2 === 0 ? "bg-blue-100" : "bg-blue-300";
        //       const buildingDiv = document.createElement("div");
        //       buildingDiv.classList.add(
        //         bgColor,
        //         // "p-4",
        //         "py-2",
        //         "px-2",
        //         "rounded",
        //         "shadow",
        //         "mb-2",
        //         "md:mb-2"
        //       );
        //       buildingDiv.innerHTML = `
        //             <div class="flex justify-between items-center">
        //                 <div>
        //                     <h2 class="text-lg font-bold cursor-pointer -mt-2 md:-mt-1">${
        //                       building.name
        //                     }</h2>
        //                     <div class="flex space-x-2 mt-1 w">
        //                         <div class="${
        //                           building.numVacantFlats > 0
        //                             ? "bg-red-800"
        //                             : "bg-green-800"
        //                         } text-white text-sm px-2 py-1 rounded w-16">
        //                             ${
        //                               building.numVacantFlats > 0
        //                                 ? "Vacancy"
        //                                 : "Full"
        //                             }
        //                         </div>
        //                         <div class="${
        //                           building.maintenance === "yes"
        //                             ? "bg-red-800"
        //                             : "bg-green-800"
        //                         } text-white text-sm px-2 py-1 rounded w-24">
        //                             ${
        //                               building.maintenance === "yes"
        //                                 ? "Maint. Reqd."
        //                                 : "No Maint."
        //                             }
        //                         </div>
        //                     </div>
        //                 </div>
        //                 <div class="flex space-x-2">
        //                     <button class="w-9 h-9 flex items-center justify-center border border-white-800 bg-green-600 shadow-md text-white p-0 rounded shareButton"><img src="../Images4Estate/share_google.svg" alt="" class="w-7 h-7" /></button>
        //                     <button class="w-9 h-9 flex items-center justify-center border border-white-800 bg-gray-600 shadow-md text-white p-0 rounded editButton"><img src="../Images4Estate/edit_google.svg" alt="" class="w-7 h-7" /></button>
        //                     <button class="w-9 h-9 flex items-center justify-center border border-white-800 bg-red-600  shadow-md text-white p-0 rounded deleteButton"><img src="../Images4Estate/delete_Bin Google.svg" alt="" class="w-7 h-7" /></button>
        //                 </div>
        //             // </div>
        document
          .getElementById("searchImage")
          .addEventListener("click", loadBuildings);
        document
          .getElementById("searchBox")
          .addEventListener("input", loadBuildings);
        document
          .getElementById("searchCriteria")
          .addEventListener("change", loadBuildings);

        function loadBuildings() {
          const searchCriteria =
            document.getElementById("searchCriteria").value;
          const searchBox = document
            .getElementById("searchBox")
            .value.toLowerCase();
          buildingList.innerHTML = "";
          const transaction = db.transaction(["buildings"], "readonly");
          const objectStore = transaction.objectStore("buildings");
          const request = objectStore.openCursor();
          let index = 0;

          request.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
              const building = cursor.value;
              const bgColor = index % 2 === 0 ? "bg-blue-100" : "bg-blue-300";
              const buildingDiv = document.createElement("div");
              buildingDiv.classList.add(
                bgColor,
                "py-2",
                "px-2",
                "rounded",
                "shadow",
                "mb-2",
                "md:mb-2"
              );

              const maintenanceStatus =
                building.maintenance === "yes" ? "Maint. Reqd." : "No Maint.";
              const vacantStatus =
                building.numVacantFlats > 0 ? "Vacancy" : "Full";

              buildingDiv.innerHTML = `
                  <div class="flex justify-between items-center">
                      <div>
                          <h2 class="text-lg font-bold cursor-pointer -mt-1 md:-mt-1">${
                            building.name
                          }</h2>
                          <div class="flex space-x-2 mt-1 w">
                              <div class="${
                                building.numVacantFlats > 0
                                  ? "bg-red-800"
                                  : "bg-green-800"
                              } text-white text-sm px-2 py-1 rounded w-16 vacant-status">
                                  ${vacantStatus}
                              </div>
                              <div class="${
                                building.maintenance === "yes"
                                  ? "bg-red-800"
                                  : "bg-green-800"
                              } text-white text-sm px-2 py-1 rounded w-24 maintenance-status">
                                  ${maintenanceStatus}
                              </div>
                          </div>
                      </div>
                      <div class="flex space-x-2">
                              <button class="w-9 h-9 flex items-center justify-center border border-white-800 bg-green-600 shadow-md text-white p-0 rounded shareButton"><img src="Images4Estate/share_google.svg" alt="" class="w-7 h-7" /></button>
                              <button class="w-9 h-9 flex items-center justify-center border border-white-800 bg-gray-600 shadow-md text-white p-0 rounded editButton"><img src="Images4Estate/edit_google.svg" alt="" class="w-7 h-7" /></button>
                              <button class="w-9 h-9 flex items-center justify-center border border-white-800 bg-red-600  shadow-md text-white p-0 rounded deleteButton"><img src="Images4Estate/delete_Bin Google.svg" alt="" class="w-7 h-7" /></button>
                          </div>
                  </div>



                      <div class="details hidden mt-1">
                          <p><strong>Address:</strong> ${building.address}</p>
                          <p><strong>No. of Flats:</strong> ${
                            building.numFlats
                          }</p>
                          <p><strong>No. of Tenants:</strong> ${
                            building.numTenants
                          }</p>
                          <p><strong>No. of Vacant Flats:</strong> ${
                            building.numVacantFlats
                          }</p>
                          <p><strong>No. of Paid-up Tenants:</strong> ${
                            building.numPaidTenants
                          }</p>
                          <p><strong>No. of Tenants Owing:</strong> ${
                            building.numTenantsOwing
                          }</p>
                          <p><strong>Notes:</strong> ${building.notes}</p>
                      </div>
                  `;

              buildingDiv.querySelector("h2").addEventListener("click", () => {
                buildingDiv
                  .querySelector(".details")
                  .classList.toggle("hidden");
              });

              buildingDiv
                .querySelector(".shareButton")
                .addEventListener("click", () => {
                  // Implement sharing functionality here
                });

              buildingDiv
                .querySelector(".editButton")
                .addEventListener("click", () => {
                  editMode = true;
                  editId = building.id;
                  form.buildingName.value = building.name;
                  form.address.value = building.address;
                  form.numFlats.value = building.numFlats;
                  form.numTenants.value = building.numTenants;
                  form.numPaidTenants.value = building.numPaidTenants;
                  form.maintenance.value = building.maintenance;
                  form.notes.value = building.notes;
                  buildingForm.classList.remove("hidden");
                  submitButton.classList.add("hidden");
                  saveButton.classList.remove("hidden");
                });

              buildingDiv
                .querySelector(".deleteButton")
                .addEventListener("click", () => {
                  if (
                    confirm("Are you sure you want to delete this building?")
                  ) {
                    deleteBuilding(building.id);
                  }
                });

              // Filter logic (SEARCH FUNCTIONALITY)
              let matchesCriteria = false;
              switch (searchCriteria) {
                case "allBuildings":
                  matchesCriteria = true;
                  break;
                case "BuildingSearch":
                  matchesCriteria = building.name
                    .toLowerCase()
                    .includes(searchBox);
                  break;
                case "fullyRented":
                  matchesCriteria = vacantStatus === "Full";
                  break;
                case "vacantFlats":
                  matchesCriteria = vacantStatus === "Vacancy";
                  break;
                case "maintenance":
                  matchesCriteria = maintenanceStatus === "Maint. Reqd.";
                  break;
                case "noMaintenance":
                  matchesCriteria = maintenanceStatus === "No Maint.";
                  break;
              }

              if (matchesCriteria) {
                buildingList.appendChild(buildingDiv);
                index++;
              }

              cursor.continue();
            }
          };

          request.onerror = (event) => {
            console.error(
              "Error retrieving buildings:",
              event.target.errorCode
            );
          };

          //     buildingList.appendChild(buildingDiv);
          //     index++;
          //     cursor.continue();
          //   }
          // };
        }

        function deleteBuilding(id) {
          const transaction = db.transaction(["buildings"], "readwrite");
          const objectStore = transaction.objectStore("buildings");
          const request = objectStore.delete(id);

          request.onsuccess = () => {
            loadBuildings();
          };

          request.onerror = (event) => {
            console.error("Delete building error:", event.target.errorCode);
          };
        }
      });

      // Register service Worker for progressive Web App (WPA)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/service-worker.js").then(
            (registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            },
            (error) => {
              console.log("ServiceWorker registration failed: ", error);
            }
          );
        });
      }
    </script>
  </body>
</html>
